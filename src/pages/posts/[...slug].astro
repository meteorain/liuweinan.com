---
import Layout from "@layouts/Layout.astro";
import { useLocale } from "@utils/locale";
import { formatDateYMD } from "@utils/format";
import ObsidianEdit from "@components/ObsidianEdit.astro";
import { getCollection, getEntry, render } from "astro:content";
import { getPostsCollectionName } from "@utils/content";
import "../../styles/content.css";

export const prerender = true;
const { path, t, locale } = useLocale(Astro.url);
const { slug } = Astro.params;

// Safety check: ensure slug exists
if (!slug) {
    return new Response(null, {
        status: 404,
        statusText: "Not found",
    });
}

// Get the correct collection based on locale
const collectionName = getPostsCollectionName(locale);

const entry = await getEntry(collectionName, slug);

if (!entry) {
    return new Response(null, {
        status: 404,
        statusText: "Not found",
    });
}

const { filePath } = entry;
let renderResult;
try {
    // Use render function (same as docs page)
    // This will trigger remark plugins including remark-modified-time
    renderResult = await render(entry);
} catch (error) {
    // Log error for debugging, especially in build environment
    console.error(`[posts/[...slug]] Error rendering entry ${slug}:`, error);
    throw error;
}

const { Content, remarkPluginFrontmatter } = renderResult;

// 修复 astro-i18n-aut 导致 remarkPluginFrontmatter 为空的问题
// 如果 remarkPluginFrontmatter 为空，手动填充它
let frontmatter = remarkPluginFrontmatter;

const { lastModified } = frontmatter || {};

const { categories, title, pubDate } = entry.data;
const ext = filePath.split(".").pop();
// const {Content} = await render(post);
export async function getStaticPaths() {
    const paths: any[] = [];

    // Get Chinese posts - these will be rendered for default locale (zh)
    const zhPosts = await getCollection("posts");
    paths.push(
        ...zhPosts.map((note) => {
            return {
                params: {
                    slug: note.slug,
                },
            };
        }),
    );

    // Get English posts - these will be rendered for 'en' locale
    // astro-i18n-aut will automatically generate /en/posts/... paths
    const enPosts = await getCollection("posts-en");
    paths.push(
        ...enPosts.map((note) => {
            return {
                params: {
                    slug: note.slug,
                },
            };
        }),
    );

    return paths;
}

// const title = locale === 'en' && FrontMatter['title-en'] ? FrontMatter['title-en'] : FrontMatter['title']
---

<Layout title={title} navbar={false}>
    <a class="panda-link mt-6" href={path("/")}>{t("post.back")}</a>

    <main>
        <div class="mt-6">
            <h1 class="text-4xl">{title}</h1>
            <div
                class="flex sm:flex-row flex-col rounded-lg bg-stone-100 dark:bg-stone-800 p-2 px-4"
            >
                <div>
                    {
                        categories &&
                            categories.map((category) => (
                                <span class="ml-1">
                                    <a
                                        href={path("/categories/" + category)}
                                        class="text-sm mr-2 panda-link"
                                    >
                                        #{t("categories." + category)}#
                                    </a>
                                </span>
                            ))
                    }
                </div>
                <span
                    class="sm:ml-auto ml-0 mt-1 sm:mt-0 pl-1 text-sm font-normal"
                >
                    {t("post.post_at")} {formatDateYMD(pubDate)}</span
                >
            </div>
        </div>
        <article class="prose dark:prose-invert prose-netrual max-w-prose mt-6">
            <Content />
        </article>
        <div class="mt-9 flex text-sm font-italic opacity-80">
            <ObsidianEdit />
            {
                lastModified && pubDate !== lastModified ? (
                    <span class="ml-auto">
                        {t("post.last_modified_at")}{" "}
                        {formatDateYMD(lastModified)} |
                    </span>
                ) : !lastModified ? (
                    <span class="ml-auto">{t("post.no_modified_time")} |</span>
                ) : null
            }
            <a
                class="panda-link ml-2"
                href={path(`/raw/posts/${entry.slug}.${ext}`)}
            >
                {ext === "md" ? "Markdown" : "MDX"}
            </a>
        </div>
    </main>
</Layout>
