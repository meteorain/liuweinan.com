---
// get api url from env


import {API_URL,API_SECRET} from 'astro:env/server'

const apiUrl = API_URL + '/moments'
const secret = API_SECRET
---
<div id="moment-editor" data-api={apiUrl} data-api-secret={secret}>
    <div class="mt-4 flex flex-col">
        <label for="tag">
            <h3>Tags</h3>
            <select id="tag" class="p-1 pr-5">
                <option value="影视">影视</option>
                <option value="音乐">音乐</option>
                <option value="叽叽喳喳">叽叽喳喳</option>
            </select>
        </label>
        <label for="content">
            <h3>Content</h3>
        </label>
        <textarea rows="9" id="content"></textarea>

    </div>
    <div class="flex">
        <span id="notification" class="mt-4"></span>
        <button class="btn btn-primary mt-4 ml-auto">Submit</button>
    </div>
</div>

<script>
    function updateNotificationMessage(msg) {
        document.getElementById('notification').innerText = msg
    }
    // get api url from element
    const apiUrl = document.getElementById('moment-editor').getAttribute('data-api')
    const secret = document.getElementById('moment-editor').getAttribute('data-api-secret')
    document.querySelector('.btn').addEventListener('click', async () => {
        let tag = document.getElementById('tag').value
        // handle tag change
        let content = document.getElementById('content').value
        // send data to api
        const {status,text} = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + secret
            },
            body: JSON.stringify({
                tags:tag,
                body:content
            })
        })
        if (status === 201) {
            updateNotificationMessage('post Success!')
        } else {
            updateNotificationMessage('post Failed:' + await text())
        }
    })
</script>